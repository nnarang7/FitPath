 <!-- singleEvent 
//0: Event Name
//1: Event address 
//2: starting time
//3: ending time -->


<!DOCTYPE html>
<html>
  <head>
    <script type="text/javascript" src="https://mandrillapp.com/api/docs/js/mandrill.js"></script>
    <script type="text/javascript" src="send-email.js"></script>
    <script type="text/javascript" src="parse.js"></script>
    <script type="text/javascript" src="https://mandrillapp.com/api/docs/js/mandrill.js"></script>
    <link rel="stylesheet" type="text/css" href="map.css">
    <meta name="viewport" content="initial-scale=1.0, user-scalable=no">
    <meta charset="utf-8">
    <title>RouteEx Map</title>
    <style>
      html, body {
        height: 100%;
        margin: 0;
        padding: 0;
      }
      #map {
        height: 100%;
      }
    </style>
  </head>
  <body>

    <script>
    var favorites = ["12TH AND ARCH STREETS PHILADELPHIA, PA 19107","Independence National Historical Park","Independence National Historical Park",
    "The Liberty Bell Center","Independence Hall","The Philadelphia Zoo","Longwood Gardens","The Franklin Institute","The Betsy Ross House",
    "Philadelphia Museum of Art","National Constitution Center","Penn Park, PA","Jon Huntsman Hall","30th street station, Philadelphia","Penn Museum",
    "Philadelphia Chinatown"];
    console.log(favorites.length);
    //Getting infomation of testEvents from Natasha 
      /*var testEvents = [["aaa","Philadelphia Chinatown","2015-09-07T08:08:00-04:00","2015-09-07T19:09:00-04:00"], 
      //reading terminal market
        ["bbb","Jon Huntsman Hall","2015-09-07T10:00:00-04:00","2015-09-07T11:00:00-04:00"],
        ["e","National Constitution Center","2015-09-07T15:00:00-04:00","2015-09-07T17:00:00-04:00"]]; */
        console.log(JSON.parse(localStorage["locations"]));
        var testEvents = JSON.parse(localStorage["locations"]);
        console.log(testEvents);
      var eventNum = testEvents.length;
      var user_email = "yyue@wharton.upenn.edu";
      var i;
      for (i = 0; i < eventNum; i++)
      {
        testEvents[i][2] = parse(testEvents[i][2]);
        testEvents[i][3] = parse(testEvents[i][3]);
      }
      //var user_email = "viviange0830@gmail.com";
    </script>


    <div id = "emailContent">
      <div class="list boxes" id="directions_panel"></div>
    </div>
      <div class="map boxes" id="map"></div>
    <div id = "emaildiv">
      <button id ='email' onclick="sendTheMail(); return false;">E-mail Me My Route!</button>
      <pre id="response"></pre>
    </div>  
  

<script>
// This example displays a marker at the center of Australia.
// When the user clicks the marker, an info window opens.
 //<button id="emailButton" onclick="sendEmail()">Send to me Email</button>
 
 function popitup(url) {
   newwindow = window.open(url, 'name', 'height=200,width=150');
   if (window.focus) {
    newwindow.focus();
   }
   return false;
 }
 
 
function initMap() {
  var i;
  var directionsDisplay = new google.maps.DirectionsRenderer;
  var directionsService = new google.maps.DirectionsService;
  var infowindows = new Array(eventNum);
  var locations = new Array(eventNum);
  var contentStrings = new Array(eventNum);
  var markers = new Array(eventNum);
  //var centerLoc = testEvents[0][4];
  //create empty LatLngBounds object for autocentering
  var bounds = new google.maps.LatLngBounds();
  var map = new google.maps.Map(document.getElementById('map'), {
    zoom: 4
  });
  directionsDisplay.setMap(map);
  directionsDisplay.setPanel(document.getElementById('directions_panel'));
 // google.maps.event.trigger(map, 'resize');
  var waypts = [];
  //Create the markers and contentStrings for the infowindow
  for (i = 0; i < eventNum; i++)
  {
    //locations[i] = testEvents[i][4];
    var order = i + 1;
    contentStrings[i] = 'Event ' + order + ':  ' + testEvents[i][0] + '<br>' 
    + 'Address:  ' + testEvents[i][1] + '<br>';
    contentStrings[i] += 'From ' + testEvents[i][2] + ' to ' + testEvents[i][3];
    console.log(contentStrings[i]);
    markers[i] = new google.maps.Marker
    ({
      address: testEvents[i][1],
      map: map,
      title: 'Location' + i
    });
  }
  //calculateAndDisplayRoute(directionsService, directionsDisplay);
  //Create info window when onclick
  var infowindow = null;
  var infowindow = new google.maps.InfoWindow()
  for (i = 0; i < eventNum; i++)
  {
    var content = contentStrings[i];
    var marker = markers[i];
      //extend the bounds to include each marker's position
  //  bounds.extend(marker.position);
    google.maps.event.addListener(marker,'click', (function(marker,content,infowindow){ 
          return function() {
             infowindow.setContent(content);
             infowindow.open(map,marker);
          };
      })(marker,content,infowindow)); 
  }
  //now fit the map to the newly inclusive bounds
  map.fitBounds(bounds);
  // DisplayRoute(current Location to the next place)
    var start = testEvents[0][1];
    var end = testEvents[eventNum-1][1];
    for (i = 1; i < eventNum - 1; i++)
    {
      waypts.push({
        location: testEvents[i][1],
        stopover:true
      })
    }
    directionsService.route({
      origin: start,
      destination: end,
      waypoints: waypts,
      travelMode: google.maps.TravelMode.WALKING
    }, function(response, status) {
      if (status === google.maps.DirectionsStatus.OK) {
        directionsDisplay.setDirections(response);
        var route = response.routes[0];
      } else {
        window.alert('Directions request failed due to ' + status);
      }
    });
}
  </script>
  <script async defer
        src="https://maps.googleapis.com/maps/api/js?signed_in=true&callback=initMap">
  </script>
  </body>
</html>
